name: CI - Automated Testing

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  android-unit-tests:
    name: Android Unit Tests
    runs-on: ubuntu-latest
    needs: [] # Can run in parallel

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission
        run: chmod +x ./android/gradlew

      - name: Run unit tests
        run: ./gradlew testDebugUnitTest --stacktrace
        working-directory: ./android

      - name: Generate test coverage report
        run: ./gradlew jacocoTestReport
        working-directory: ./android

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-unit-test-results
          path: |
            android/**/build/test-results/**/*.xml
            android/**/build/reports/tests/

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: android-coverage-report
          path: android/**/build/reports/jacoco/

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: codecov/codecov-action@v4
        with:
          files: ./android/app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
          flags: android-unit
          name: android-unit-tests

  functions-unit-tests:
    name: Firebase Functions Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./functions

      - name: Run unit tests
        run: npm run test:unit -- --coverage
        working-directory: ./functions

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: functions-unit-test-results
          path: functions/test-results/

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: ./functions/coverage/lcov.info
          flags: functions-unit
          name: functions-unit-tests

  android-integration-tests:
    name: Android Integration Tests (Firebase Emulator)
    runs-on: ubuntu-latest
    needs: [android-unit-tests, functions-unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Set up Node.js (for Firebase Emulator)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Firebase Emulators
        run: |
          firebase emulators:start --only firestore,auth,storage --project demo-test &
          echo "Waiting for emulators to start..."
          sleep 10
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      - name: Grant execute permission
        run: chmod +x ./android/gradlew

      - name: Run integration tests
        run: ./gradlew connectedDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.useEmulator=true
        working-directory: ./android
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
          FIREBASE_STORAGE_EMULATOR_HOST: localhost:9199

      - name: Stop emulators
        if: always()
        run: firebase emulators:stop

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-integration-test-results
          path: android/**/build/outputs/androidTest-results/

  functions-integration-tests:
    name: Firebase Functions Integration Tests
    runs-on: ubuntu-latest
    needs: [functions-unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install dependencies
        run: npm ci
        working-directory: ./functions

      - name: Start Firebase Emulators
        run: |
          firebase emulators:start --only firestore,functions,auth --project demo-test &
          echo "Waiting for emulators to start..."
          sleep 15
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      - name: Run integration tests
        run: npm run test:integration
        working-directory: ./functions
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099

      - name: Stop emulators
        if: always()
        run: firebase emulators:stop

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: functions-integration-test-results
          path: functions/test-results/

  test-coverage-gate:
    name: Test Coverage Gate
    runs-on: ubuntu-latest
    needs: [android-unit-tests, functions-unit-tests, android-integration-tests, functions-integration-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download all coverage reports
        uses: actions/download-artifact@v4

      - name: Check coverage thresholds
        run: |
          echo "Checking coverage thresholds..."
          # Add coverage threshold checks here
          # Fail if coverage < 80%

      - name: Generate combined coverage report
        run: |
          echo "All tests passed with sufficient coverage!"

  test-success:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [test-coverage-gate]

    steps:
      - name: Success
        run: echo "All tests passed! Ready for build."
