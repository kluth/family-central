name: CD - Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (e.g., v1.0.0)

jobs:
  validate-tag:
    name: Validate Release Tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate semantic version tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          if ! [[ $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format: $TAG"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "Valid tag: $TAG"

      - name: Extract version
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

  build-release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [validate-tag]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission
        run: chmod +x ./android/gradlew

      - name: Create dummy google-services.json
        run: |
          cat > android/app/google-services.json << 'EOF'
          {
            "project_info": {
              "project_number": "123456789000",
              "project_id": "familyhub-demo",
              "storage_bucket": "familyhub-demo.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789000:android:0000000000000000000000",
                  "android_client_info": {
                    "package_name": "com.familyhub.app"
                  }
                },
                "oauth_client": [
                  {
                    "client_id": "123456789000-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com",
                    "client_type": 3
                  }
                ],
                "api_key": [
                  {
                    "current_key": "AIzaSyDemoKey_NotRealFirebaseKey_ForBuildOnly"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": [
                      {
                        "client_id": "123456789000-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com",
                        "client_type": 3
                      }
                    ]
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release-keystore.jks

      - name: Update version in build.gradle
        run: |
          VERSION=${{ needs.validate-tag.outputs.version }}
          sed -i "s/versionName \".*\"/versionName \"$VERSION\"/" android/app/build.gradle.kts

      - name: Build release AAB
        run: ./gradlew bundleRelease --stacktrace --no-daemon
        working-directory: ./android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Build release APKs (Phone + Wear)
        run: ./gradlew assembleRelease :wear:assembleRelease --stacktrace --no-daemon
        working-directory: ./android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Sign AAB
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore android/app/release-keystore.jks \
            -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
            -keypass ${{ secrets.KEY_PASSWORD }} \
            android/app/build/outputs/bundle/release/app-release.aab \
            ${{ secrets.KEY_ALIAS }}

      - name: Sign Phone APK
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore android/app/release-keystore.jks \
            -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
            -keypass ${{ secrets.KEY_PASSWORD }} \
            android/app/build/outputs/apk/release/app-release-unsigned.apk \
            ${{ secrets.KEY_ALIAS }}

      - name: Sign Wear OS APK
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore android/app/release-keystore.jks \
            -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
            -keypass ${{ secrets.KEY_PASSWORD }} \
            android/wear/build/outputs/apk/release/wear-release-unsigned.apk \
            ${{ secrets.KEY_ALIAS }}

      - name: Verify AAB signature
        run: jarsigner -verify android/app/build/outputs/bundle/release/app-release.aab

      - name: Verify Phone APK signature
        run: jarsigner -verify android/app/build/outputs/apk/release/app-release-unsigned.apk

      - name: Verify Wear APK signature
        run: jarsigner -verify android/wear/build/outputs/apk/release/wear-release-unsigned.apk

      - name: Rename APKs to signed
        run: |
          mv android/app/build/outputs/apk/release/app-release-unsigned.apk \
             android/app/build/outputs/apk/release/FamilyHub-${{ needs.validate-tag.outputs.version }}.apk
          mv android/wear/build/outputs/apk/release/wear-release-unsigned.apk \
             android/wear/build/outputs/apk/release/FamilyHub-Wear-${{ needs.validate-tag.outputs.version }}.apk

      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: familyhub-aab-${{ needs.validate-tag.outputs.version }}
          path: android/app/build/outputs/bundle/release/app-release.aab

      - name: Upload signed Phone APK
        uses: actions/upload-artifact@v4
        with:
          name: familyhub-phone-apk-${{ needs.validate-tag.outputs.version }}
          path: android/app/build/outputs/apk/release/FamilyHub-${{ needs.validate-tag.outputs.version }}.apk

      - name: Upload signed Wear APK
        uses: actions/upload-artifact@v4
        with:
          name: familyhub-wear-apk-${{ needs.validate-tag.outputs.version }}
          path: android/wear/build/outputs/apk/release/FamilyHub-Wear-${{ needs.validate-tag.outputs.version }}.apk

      - name: Clean up keystore
        if: always()
        run: rm -f android/app/release-keystore.jks

  # Google Play deployment disabled - deploying to GitHub Releases only
  # To enable Google Play deployment, uncomment this job and add required secrets:
  # - GOOGLE_PLAY_SERVICE_ACCOUNT_JSON
  #
  # deploy-google-play:
  #   name: Deploy to Google Play Internal Track
  #   runs-on: ubuntu-latest
  #   needs: [validate-tag, build-release]
  #   environment: production
  #   steps:
  #     - name: Upload to Google Play
  #       ...


  build-and-deploy-functions:
    name: Deploy Firebase Functions
    runs-on: ubuntu-latest
    needs: [validate-tag]
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./functions

      - name: Run tests before deploy
        run: npm test
        working-directory: ./functions

      - name: Build functions
        run: npm run build
        working-directory: ./functions

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase (Functions, Rules, Indexes, Storage)
        run: |
          # Deploy all Firebase resources using official Firebase CLI
          firebase deploy \
            --only functions,firestore:rules,firestore:indexes,storage \
            --project ${{ secrets.FIREBASE_PROJECT_ID }} \
            --non-interactive
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-tag, build-release, build-and-deploy-functions]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: familyhub-aab-${{ needs.validate-tag.outputs.version }}
          path: ./artifacts/

      - name: Download Phone APK
        uses: actions/download-artifact@v4
        with:
          name: familyhub-phone-apk-${{ needs.validate-tag.outputs.version }}
          path: ./artifacts/

      - name: Download Wear APK
        uses: actions/download-artifact@v4
        with:
          name: familyhub-wear-apk-${{ needs.validate-tag.outputs.version }}
          path: ./artifacts/

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..${{ needs.validate-tag.outputs.tag }} --pretty=format:"- %s (%h)" --no-merges)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install GitHub CLI
        run: |
          type gh &>/dev/null || echo "GitHub CLI already installed"
          gh --version

      - name: Create GitHub Release
        run: |
          # Create release notes file
          cat > release_notes.md << 'RELEASE_NOTES_EOF'
            ## FamilyHub Platform Release ${{ needs.validate-tag.outputs.version }}

            ### ðŸš€ What's New
            ${{ steps.changelog.outputs.changelog }}

            ### ðŸ“¦ Downloads

            #### ðŸ“± Android Phone App
            - **FamilyHub-${{ needs.validate-tag.outputs.version }}.apk** - Direct install APK for Android phones
            - **app-release.aab** - Android App Bundle for Google Play Store

            #### âŒš Wear OS App
            - **FamilyHub-Wear-${{ needs.validate-tag.outputs.version }}.apk** - Direct install APK for Wear OS watches

            ### ðŸ“² Installation Instructions

            #### Phone App Installation:
            1. Download `FamilyHub-${{ needs.validate-tag.outputs.version }}.apk`
            2. Enable "Install from Unknown Sources" in Android settings
            3. Open the APK file and follow installation prompts
            4. Grant required permissions when launching the app

            #### Wear OS Installation:
            1. First install the phone app
            2. Download `FamilyHub-Wear-${{ needs.validate-tag.outputs.version }}.apk`
            3. Use `adb install` or a file manager app on your watch
            4. Grant health and sensor permissions

            ### âœ¨ Features
            - ðŸ“‹ **Tasks**: Family task management with priorities
            - ðŸ’¬ **Chat**: Real-time family messaging
            - ðŸ“… **Calendar**: Shared family events and schedules
            - ðŸ›’ **Shopping**: Collaborative shopping lists
            - ðŸ‘¤ **Profile**: User settings and preferences
            - âŒš **Wear OS**: Full companion app with health tracking

            ### ðŸ”¥ Backend
            - **Firebase Functions**: Deployed to production
            - **Firestore Rules**: Updated and deployed
            - **Storage Rules**: Updated and deployed

            ### ðŸ”— Links
            - [Firebase Console](https://console.firebase.google.com)
            - [GitHub Repository](https://github.com/${{ github.repository }})

            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ needs.validate-tag.outputs.tag }}...HEAD
          RELEASE_NOTES_EOF

          # Create GitHub release using official GitHub CLI
          gh release create "${{ needs.validate-tag.outputs.tag }}" \
            ./artifacts/app-release.aab \
            ./artifacts/FamilyHub-${{ needs.validate-tag.outputs.version }}.apk \
            ./artifacts/FamilyHub-Wear-${{ needs.validate-tag.outputs.version }}.apk \
            --title "Release ${{ needs.validate-tag.outputs.version }}" \
            --notes-file release_notes.md \
            --latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-deployment:
    name: Send Deployment Notifications
    runs-on: ubuntu-latest
    needs: [validate-tag, create-github-release]
    if: always()

    steps:
      - name: Notify success
        if: needs.create-github-release.result == 'success'
        run: |
          echo "âœ… Deployment successful!"
          echo "Version ${{ needs.validate-tag.outputs.version }} deployed to production"
          # Add Slack/Discord notification here if needed

      - name: Notify failure
        if: needs.create-github-release.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "Check logs for details"
          # Add Slack/Discord notification here if needed
          exit 1

  deployment-success:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [build-and-deploy-functions, create-github-release]

    steps:
      - name: Success
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "Version ${{ needs.validate-tag.outputs.version }} is now live!"
