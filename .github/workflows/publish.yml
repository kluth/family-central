name: CD - Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (e.g., v1.0.0)

jobs:
  validate-tag:
    name: Validate Release Tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate semantic version tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          if ! [[ $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format: $TAG"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "Valid tag: $TAG"

      - name: Extract version
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

  build-release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [validate-tag]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission
        run: chmod +x ./android/gradlew

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release-keystore.jks

      - name: Update version in build.gradle
        run: |
          VERSION=${{ needs.validate-tag.outputs.version }}
          sed -i "s/versionName \".*\"/versionName \"$VERSION\"/" android/app/build.gradle.kts

      - name: Build release AAB
        run: ./gradlew bundleRelease --stacktrace
        working-directory: ./android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Sign AAB
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore android/app/release-keystore.jks \
            -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
            -keypass ${{ secrets.KEY_PASSWORD }} \
            android/app/build/outputs/bundle/release/app-release.aab \
            ${{ secrets.KEY_ALIAS }}

      - name: Verify AAB signature
        run: jarsigner -verify android/app/build/outputs/bundle/release/app-release.aab

      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: familyhub-release-${{ needs.validate-tag.outputs.version }}
          path: android/app/build/outputs/bundle/release/app-release.aab

      - name: Clean up keystore
        if: always()
        run: rm -f android/app/release-keystore.jks

  # Google Play deployment disabled - deploying to GitHub Releases only
  # To enable Google Play deployment, uncomment this job and add required secrets:
  # - GOOGLE_PLAY_SERVICE_ACCOUNT_JSON
  #
  # deploy-google-play:
  #   name: Deploy to Google Play Internal Track
  #   runs-on: ubuntu-latest
  #   needs: [validate-tag, build-release]
  #   environment: production
  #   steps:
  #     - name: Upload to Google Play
  #       ...


  build-and-deploy-functions:
    name: Deploy Firebase Functions
    runs-on: ubuntu-latest
    needs: [validate-tag]
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./functions

      - name: Run tests before deploy
        run: npm test
        working-directory: ./functions

      - name: Build functions
        run: npm run build
        working-directory: ./functions

      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      - name: Deploy Firestore rules
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only firestore:rules --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      - name: Deploy Firestore indexes
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only firestore:indexes --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      - name: Deploy Storage rules
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only storage --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-tag, build-release, build-and-deploy-functions]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: familyhub-release-${{ needs.validate-tag.outputs.version }}

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..${{ needs.validate-tag.outputs.tag }} --pretty=format:"- %s (%h)" --no-merges)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate-tag.outputs.tag }}
          name: Release ${{ needs.validate-tag.outputs.version }}
          body: |
            ## FamilyHub Platform Release ${{ needs.validate-tag.outputs.version }}

            ### üöÄ What's New
            ${{ steps.changelog.outputs.changelog }}

            ### üì¶ Downloads
            - **Android APK/AAB**: Download from attachments below
            - **Firebase Functions**: Deployed to production

            ### üîó Links
            - [Firebase Console](https://console.firebase.google.com)
            - [GitHub Repository](https://github.com/${{ github.repository }})

            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ needs.validate-tag.outputs.tag }}...HEAD
          files: app-release.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-deployment:
    name: Send Deployment Notifications
    runs-on: ubuntu-latest
    needs: [validate-tag, create-github-release]
    if: always()

    steps:
      - name: Notify success
        if: needs.create-github-release.result == 'success'
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Version ${{ needs.validate-tag.outputs.version }} deployed to production"
          # Add Slack/Discord notification here if needed

      - name: Notify failure
        if: needs.create-github-release.result == 'failure'
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check logs for details"
          # Add Slack/Discord notification here if needed
          exit 1

  deployment-success:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [build-and-deploy-functions, create-github-release]

    steps:
      - name: Success
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "Version ${{ needs.validate-tag.outputs.version }} is now live!"
